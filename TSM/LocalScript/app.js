var showForPages = ["*://*.skyeng.ru/*","*://skyeng.autofaq.ai/*","*://*.slack.com/*","*://jira.skyeng.tech/*","*://*.skyeng.tech/*"]; //—Ñ–∏–ª—å—Ç—Ä —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∞—Å—å –¥–ª—è —Å–∞–π—Ç–æ–≤ –∏–∑ –≤–Ω–µ—Å–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ—á–Ω—è –∏–Ω–∞—á–µ –µ—Å–ª–∏ –Ω–µ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ—Ç–æ–º –ø—Ä–∏ –æ–±—å—è–≤–ª–µ–Ω–∏–∏ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö –æ–ø—Ü–∏–π –æ–Ω–∏ –±—É–¥—É—Ç –Ω–∞ –≤—Å–µ—Ö —Å–∞–π—Ç–∞—Ö —ç—Ç–∞ "documentUrlPatterns":showForPages –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∏ –≤–Ω–æ—Å–∏—Ç—Å—è –ø—Ä–∏ –æ–±—å—è–≤–ª–µ–Ω–∏–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü 

//–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª–æ–≤ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
var ChanelDev = "hg8rcub4pfg3dcae8jxkwzkq9h";
var ChanelSupport = "pspyooisr3rd7qzx9as8uc96xc";

let lastChatId = null; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ chatid
let lastMessage = null; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

var main = chrome.contextMenus.create( {"id":"mainoption","title": "Technical Support Master", "documentUrlPatterns":showForPages} ); //–æ–±—å—è–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –æ—Ç–≤–µ—á–∞–µ—Ç —Å–≤–æ–π—Å—Ç–≤–æ page –∏ —Ç–∞–∫–∂–µ –≤ –¥–æ—á–µ—Ä–Ω–∏—Ö –≤–µ—Ç–∫–∞—Ö

chrome.contextMenus.create({"title": "üí∏ –ü–æ–∏—Å–∫ –ø–ª–∞—Ç–µ–∂–∞", "contexts":["page"], "parentId": "mainoption", "onclick": searchpayment}); //–æ–ø—Ü–∏—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∏—Å–∫ –ø–ª–∞—Ç–µ–∂–∞
function searchpayment(i){
	var createProperties = {url: encodeURI("https://accounting.skyeng.ru/userpayment/search/transaction")};
	chrome.tabs.create(createProperties);
}

chrome.contextMenus.create({"title": "üí∞ –ù–∞—á–∏—Å–ª—è—Ç–æ—Ä / üìë –ü–æ–¥–ø–∏—Å–∫–∏", "contexts":["page"], "parentId": "mainoption", "onclick": balanceinfo}); //–æ–ø—Ü–∏—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ä–∞–∑–¥–µ–ª –ù–∞—á–∏—Å–ª—è—Ç–æ—Ä –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –±–∞–ª–∞–Ω—Å–∞
function balanceinfo(i){
	var createProperties = {url: encodeURI("https://billing-api.skyeng.ru/operations")};
	chrome.tabs.create(createProperties);
}

chrome.contextMenus.create({"title": "üßæ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã / üéü –ü—Ä–æ–º–æ–∫–æ–¥—ã", "contexts":["page"], "parentId": "mainoption", "onclick": certandpromo}); //–æ–ø—Ü–∏—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ä–∞–∑–¥–µ–ª –ù–∞—á–∏—Å–ª—è—Ç–æ—Ä –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –±–∞–ª–∞–Ω—Å–∞
function certandpromo(i){
	var createProperties = {url: encodeURI("https://billing-marketing.skyeng.ru/certificate/certSearch")};
	chrome.tabs.create(createProperties);
}

chrome.contextMenus.create({"title": "üìü Timetable", "contexts":["page"], "parentId": "mainoption", "onclick": opentt}); //–æ–ø—Ü–∏—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Timetable
function opentt(i){
	var createProperties = {url: encodeURI("https://timetable.skyeng.ru/")};
	chrome.tabs.create(createProperties);
}

chrome.contextMenus.create({"title": "üìÜ –ö–∞–ª–µ–Ω–¥–∞—Ä—å (Datsy)", "contexts":["page"], "parentId": "mainoption", "onclick": opencalendar}); //–æ–ø—Ü–∏—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Datsy –∫–∞–ª–µ–Ω–¥–∞—Ä—å
function opencalendar(i){
	var createProperties = {url: encodeURI("https://datsy.info/")};
	chrome.tabs.create(createProperties);
}

chrome.contextMenus.create({"title": "üíµ –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏", "contexts":["page"], "parentId": "mainoption", "onclick": makecompens}); //–æ–ø—Ü–∏—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –û–∫–Ω–æ —Å –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è–º–∏
function makecompens(i){
	var createProperties = {url: encodeURI("https://billing-marketing.skyeng.ru/accrual-operations/create")};
	chrome.tabs.create(createProperties);
}

chrome.contextMenus.create({"title": "üíã –ê–¥–º–∏–Ω–∫–∞ Talks", "contexts":["page"], "parentId": "mainoption", "onclick": opentalksadm}); //–æ–ø—Ü–∏—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –û–∫–Ω–æ —Å –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è–º–∏
function opentalksadm(i){
	var createProperties = {url: encodeURI("https://vimbox.skyeng.ru/talks/admin/statistics")};
	chrome.tabs.create(createProperties);
}

chrome.contextMenus.create({"title": "üÜò #dev-disaster", "contexts":["page"], "parentId": "mainoption", "onclick": sendtodisaster}); //–æ–ø—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –¥–∏–∑–∞—Å—Ç–µ—Ä
async function sendtodisaster(i,t){
	
	if (!MMostOperId) { MMostOperId = await getMMostOperId() }
	
	let answersend = confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–±—É–¥–∏—Ç—å –î—Ä–µ–≤–Ω–µ–µ –ó–ª–æ –∏ –≤–æ–∑–∑–≤–∞—Ç—å –∫ –∫–æ–º–∞–Ω–¥–µ –§–∏–∫—Å–∏–∫–æ–≤ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–∞–∫–ª–∏–∑–º–∞ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ?\n–û–ö - –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è. –û—Ç–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É.")
	if (answersend) {
	var textmsg = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–µ–∫—Å—Ç –≤ —ç—Ç–æ –ø–æ–ª–µ');
	if (textmsg !== null){
        if (textmsg.length > 3) {
				await fetch("https://mattermost.skyeng.tech/api/v4/posts", {
				"headers": {
					  "accept": "*/*",
					  "accept-language": "ru",
					  "content-type": "application/json",
					  "sec-fetch-mode": "cors",
					  "sec-fetch-site": "same-origin",
					  "x-requested-with": "XMLHttpRequest"
					},
					"referrerPolicy": "no-referrer",
					"body": `{\"message\":\":allert: ${textmsg}\",\"channel_id\":\"${ChanelDev}\",\"pending_post_id\":\"${MMostOperId}:\",\"user_id\":\"${MMostOperId}\"}`,
				"method": "POST",
				"mode": "cors",
				"credentials": "include"
		  	}).then(r=>r.json()).then(r=>receiveddata=r)
				let tsresponse = receiveddata.id
				console.log(tsresponse)
				
				fetch("https://mattermost.skyeng.tech/api/v4/posts", {
						"headers": {
						  "accept": "*/*",
						  "accept-language": "ru",
						  "content-type": "application/json",
						  "sec-fetch-mode": "cors",
						  "sec-fetch-site": "same-origin",
						  "x-requested-with": "XMLHttpRequest"
						},
						"referrerPolicy": "no-referrer",
						"body": `{\"message\":\"@techsupport-team @techsupport-leads @tech-curators @pk-chats @sos-inform-teachers @teacherscareteam @outbound-team-new @m-vhod @pm-team1 @premium-support @a-players @news\",\"channel_id\":\"${ChanelDev}\",\"root_id\":\"${tsresponse}\",\"pending_post_id\":\"${MMostOperId}:\",\"user_id\":\"${MMostOperId}\"}`,
		  "method": "POST",
		  "mode": "cors",
		  "credentials": "include"
		});
						
		} else alert("–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π");
	} else console.log("–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –û—Ç–º–µ–Ω–∞");
	} else console.log("–ù–µ —É–≤–µ—Ä–µ–Ω, –∂–∞–ª—å, –ø–æ–≤–µ–∑–µ—Ç –≤ –¥—Ä—É–≥–æ–π —Ä–∞–∑!")
}	

var selmain = chrome.contextMenus.create( {"id":"selMainOption","title": "Technical Support Master", "contexts":["selection"], "documentUrlPatterns":showForPages} ); // –æ–±—å—è–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –≤—ã–¥–µ–ª–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–≤–µ—á–∞–µ—Ç —Å–≤–æ–π—Å—Ç–≤–æ selection

chrome.contextMenus.create({"title": "üîéInfo ID: %s", "contexts":["selection"], "parentId": "selMainOption", "onclick": openinfo}); 
function openinfo(i,t) { 

            let selid = i.selectionText
            console.log(selid)
            const laserExtensionId = "kggpdmfnfmmkneemhknlojemcjmdlpjb";
            let messageValue = {
                        message: 'open-user-info',
                        userId: selid,
                    }
            console.log(messageValue)
            
            let tabId = t.id
            console.log(tabId)
            
            const message = {
                messageValue,
                tabId
            }

            chrome.runtime.sendMessage(laserExtensionId,
                message,
            );
} 

chrome.contextMenus.create({"title": "üè° –°—Å—ã–ª–∫–∞-–ª–æ–≥–∏–Ω–µ—Ä –¥–ª—è ID: %s", "contexts":["selection"], "parentId": "selMainOption", "onclick": dologginer}); //–æ–ø—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –ê–ü
function dologginer(i){

// –î–∞–Ω–Ω—ã–µ –¥–ª—è form-data —Ç–æ–∫–µ–Ω –º–æ–∂–Ω–æ –≤–∑—è—Ç—å –∫–∞–∫ —Ç–µ–±–µ —É–¥–æ–±–Ω–æ
let userId = i.selectionText
let tokenId = null

// fetch
fetch("https://id.skyeng.ru/admin/auth/login-links", {
    headers: {"content-type": "application/x-www-form-urlencoded"},
    referrer: "https://id.skyeng.ru/admin/auth/login-links",
    referrerPolicy: "strict-origin-when-cross-origin",
    body: `login_link_form%5Bidentity%5D=&login_link_form%5Bid%5D=${userId}+&login_link_form%5Btarget%5D=https%3A%2F%2Fskyeng.ru&login_link_form%5Bpromocode%5D=&login_link_form%5Blifetime%5D=3600&login_link_form%5Bcreate%5D=&login_link_form%5B_token%5D=${tokenId}`,
    method: "POST",
    mode: "cors",
    credentials: "include"
})
    .then(res => res.text())
    .then(textHtml => {
        let domPars = new DOMParser()
        // let loginLink = domPars.parseFromString(textHtml, `text/html`).querySelector("[value^='https://id.skyeng.ru/auth/login-link/']").value
		let testlink =domPars.parseFromString(textHtml, `text/html`).querySelectorAll("[value^='https://id.skyeng.ru/auth/login-link/']")
		        
        // –í—ã–≤–æ–¥–∏—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Å—ã–ª–∫—É –≤ –∏–Ω–ø—É—Ç–µ 
        console.log(`Loginner: ${testlink[testlink.length-1].value}`)
		
		var copyloginlnk = document.createElement("input");
		copyloginlnk.setAttribute("value", testlink[testlink.length-1].value)
		document.body.appendChild(copyloginlnk);
		copyloginlnk.select();
		document.execCommand("copy");
		document.body.removeChild(copyloginlnk);

    })
}

chrome.contextMenus.create({"title": "üïµÔ∏è‚Äç‚ôÇÔ∏è –û—Ç–∫—Ä—ã—Ç—å CRM –¥–ª—è ID: %s", "contexts":["selection"], "parentId": "selMainOption", "onclick": opencrmid}); //–æ–ø—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –°–†–ú–∫–∏ –ø–æ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–º—É ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function opencrmid(i){
	var createProperties = { url: encodeURI("https://crm2.skyeng.ru/persons/" + i.selectionText) };
	chrome.tabs.create(createProperties);
}

chrome.contextMenus.create({"title": "üí≥ –°–ø–∏—Å–æ–∫ —Ä–∞—Å—Å—Ä–æ—á–µ–∫ –¥–ª—è ID: %s", "contexts":["selection"], "parentId": "selMainOption", "onclick": creditpayments}); //–æ–ø—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –°–†–ú–∫–∏ –ø–æ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–º—É ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function creditpayments(i){
	var createProperties = { url: encodeURI("https://accounting.skyeng.ru/credit/list?studentId=" + i.selectionText) };
	chrome.tabs.create(createProperties);
}

chrome.contextMenus.create({"title": "üÜî –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –∞–¥–º–∏–Ω–∫–µ ID: %s", "contexts":["selection"], "parentId": "selMainOption", "onclick": editadmacc}); //–æ–ø—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –°–†–ú–∫–∏ –ø–æ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–º—É ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function editadmacc(i){
	var createProperties = { url: encodeURI("https://id.skyeng.ru/admin/users/" + i.selectionText + "/update-contacts") };
	chrome.tabs.create(createProperties);
}

chrome.contextMenus.create({"title": "üéì Homework Adult ID: %s", "contexts":["selection"], "parentId": "selMainOption", "onclick": copyidstudforhw}); //–æ–ø—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ —Å ID —É—á–µ–Ω–∏–∫–∞, —á—Ç–æ–±—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ –ø–æ–¥ –ü –æ—Ç–∫—Ä—ã—Ç—å –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –µ–≥–æ –¥–æ–º–∞—à–∫–∏ (–¥–ª—è Adult)
function copyidstudforhw(i){
	var aux = document.createElement("input");
	aux.setAttribute("value", "https://vimbox.skyeng.ru/student/"  +  i.selectionText + "/homework")
	document.body.appendChild(aux);
	aux.select();
	document.execCommand("copy");
	document.body.removeChild(aux);
}

chrome.contextMenus.create({"title": "üßæ –û—Ç—á–µ—Ç –ú–í–£ ID: %s", "contexts":["selection"], "parentId": "selMainOption", "onclick": copymvureport}); //–æ–ø—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ñ–æ—Ä–º—É –æ—Ç—á–µ—Ç–∞ –ú–í–£
function copymvureport(i){
	var aux = document.createElement("input");
	aux.setAttribute("value", "https://marketing-core.skyeng.ru/report/html/report?student_id="  +  i.selectionText)
	document.body.appendChild(aux);
	aux.select();
	document.execCommand("copy");
	document.body.removeChild(aux);
}

chrome.contextMenus.create({"title": "üí® ID –£—Å–ª—É–≥–∏ Skip –ê–ü", "contexts":["selection"], "parentId": "selMainOption", "onclick": copytoskipap}); //–æ–ø—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –ê–ü
function copytoskipap(i){
	var aux = document.createElement("input");
	aux.setAttribute("value", "https://student.skyeng.ru/product-stage?stage=auto-schedule&educationServiceId="  +  i.selectionText)
	document.body.appendChild(aux);
	aux.select();
	document.execCommand("copy");
	document.body.removeChild(aux);
}

chrome.contextMenus.create({"title": "üí® ID –£—Å–ª—É–≥–∏ Skip Onboarding", "contexts":["selection"], "parentId": "selMainOption", "onclick": copytoskipap}); //–æ–ø—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –ê–ü
function copytoskipap(i){
	var aux = document.createElement("input");
	aux.setAttribute("value", "https://student.skyeng.ru/product-stage?stage=onboarding&educationServiceId="  +  i.selectionText)
	document.body.appendChild(aux);
	aux.select();
	document.execCommand("copy");
	document.body.removeChild(aux);
}

chrome.contextMenus.create({"title": "üë®‚Äçüè´ –û—Ç–∫—Ä—ã—Ç—å –¢–†–ú2.0 ID: %s", "contexts":["selection"], "parentId": "selMainOption", "onclick": opentrm}); //–æ–ø—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –ê–ü
function opentrm(i){
var createProperties = { url: encodeURI("https://trm.skyeng.ru/teacher/"  +  i.selectionText) }
	chrome.tabs.create(createProperties);
}

chrome.contextMenus.create({"title": "‚ôê –û—Ç–∫—Ä—ã—Ç—å –¢–® –ø–æ —Ö–µ—à—É: %s", "contexts":["selection"], "parentId": "selMainOption", "onclick": opntshash}); //–æ–ø—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –ê–ü
function opntshash(i){
var createProperties = { url: encodeURI("https://video-trouble-shooter.skyeng.ru/?hash="  +  i.selectionText) }
	chrome.tabs.create(createProperties);
}
// testlinkPKM

var linkparent = chrome.contextMenus.create( {"id":"linkOption","title": "Technical Support Master", "contexts":["link"], "documentUrlPatterns":showForPages} ); // –æ–±—å—è–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –≤—ã–¥–µ–ª–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–≤–µ—á–∞–µ—Ç —Å–≤–æ–π—Å—Ç–≤–æ selection

let MMostOperId ='';

chrome.contextMenus.create({"title": "üö´ –û—Ç–º–µ–Ω–∞ –¢–ü1–õ (–∏—Å—Ö–æ–¥)", "contexts":["link"], "parentId": "linkOption", "onclick": cancelishodcall}); //–æ–ø—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –¥–ª—è test msg

async function cancelishodcall(i,t) {
	MMostOperId = await getMMostOperId();
	if (MMostOperId) { 
		var message = `@techsupport-1line-crm2 ${i.linkUrl} –û—Ö—Ä–∞–Ω–∞ - –æ—Ç–º–µ–Ω–∞ üö´`;
		sendMattermostMessage(message);
	}
}

chrome.contextMenus.create({"title": "üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –¢–ü1–õ (–∏—Å—Ö–æ–¥) —Å–æ —Å—Å—ã–ª–∫–æ–π", "contexts":["link"], "parentId": "linkOption", "onclick": sendtestmsgcustommsg}); //–æ–ø—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –¥–ª—è test msg

async function sendtestmsgcustommsg(i,t) {
	MMostOperId = await getMMostOperId();
	if (MMostOperId) { 
		const textmsg = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–µ–∫—Å—Ç –≤ —ç—Ç–æ –ø–æ–ª–µ');
		if (textmsg !== null && textmsg.length > 3) {
			var message = `@techsupport-1line-crm2 ${i.linkUrl} ${textmsg}`;
			sendMattermostMessage(message);
		} else if (textmsg !== null) {
			alert("–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π");
		} else {
			console.log("–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –û—Ç–º–µ–Ω–∞");
		}
	}
}

chrome.contextMenus.create({"title": "üö´ –û—Ç–º–µ–Ω–∞ 2–õ–¢–ü", "contexts":["link"], "parentId": "linkOption", "onclick": cancelsecondline}); //–æ–ø—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –¥–ª—è test msg

async function cancelsecondline(i,t) {	MMostOperId = await getMMostOperId();
	MMostOperId = await getMMostOperId();
	if (MMostOperId) { 
		var message = `@techsupport-2line ${i.linkUrl} –û—Ö—Ä–∞–Ω–∞ - –æ—Ç–º–µ–Ω–∞ üö´`;
		sendMattermostMessage(message);
	}
}

chrome.contextMenus.create({"title": "üí¨ –ù–∞–ø–∏—Å–∞—Ç—å 2–õ–¢–ü —Å–æ —Å—Å—ã–ª–∫–æ–π", "contexts":["link"], "parentId": "linkOption", "onclick": send2ndlinetestmsgcustommsg}); //–æ–ø—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –¥–ª—è test msg

async function send2ndlinetestmsgcustommsg(i,t) {
	MMostOperId = await getMMostOperId();
	if (MMostOperId) { 
		const textmsg = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–µ–∫—Å—Ç –≤ —ç—Ç–æ –ø–æ–ª–µ');
		if (textmsg !== null && textmsg.length > 3) {
			var message = `@techsupport-2line ${i.linkUrl} ${textmsg}`;
			sendMattermostMessage(message);
		} else if (textmsg !== null) {
			alert("–¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π");
		} else {
			console.log("–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –û—Ç–º–µ–Ω–∞");
		}
	}	
}

// —Ñ—É–Ω–∫—Ü–∏—è –æ–±—â–µ–Ω–∏—è —Å stat.js —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–∞–∫–æ–π –ª–∏–±–æ –∏–Ω—Ñ—ã –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS
chrome.runtime.onMessage.addListener(function (request, sender, sendResponse) {
	    if (request.name === "Ctxt") {
			if (request.question == 'sendResponse') {
				fetch(request.addr, request.options)
					.then(response => response.text())
					.then(result => { sendResponse({answer: result, respName: request.respName}) });
				return true;
			}
		}
});

async function getMMostOperId() {
	return new Promise(async (resolve) => {
	  let MMostOperId = localStorage.getItem('matermost_oid');
  
	  if (MMostOperId !== null) {
		resolve(MMostOperId);
	  } else {
		try {
		  const response = await fetch("https://mattermost.skyeng.tech/api/v4/users/me");
		  
		  if (!response.ok) {
			throw new Error("Failed to fetch user data.");
		  }
  
		  const data = await response.json();
		  MMostOperId = data.id;
  
		  if (MMostOperId) {
			localStorage.setItem('matermost_oid', MMostOperId);
			resolve(MMostOperId);
		  }
		} catch (error) {
		  console.error("Error fetching user data:", error);
		  resolve(null); // –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞, –≤–µ—Ä–Ω—É—Ç—å null
		}
	  }
	});
  }

  function sendMattermostMessage(message) {
    lastMessage = message; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥–æ–µ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

    let bodyData = {
        message: message,
        channel_id: ChanelSupport,
        pending_post_id: `${MMostOperId}:`,
        user_id: MMostOperId
    };

    fetch("https://mattermost.skyeng.tech/api/v4/posts", {
        "headers": {
            "accept": "*/*",
            "accept-language": "ru",
            "content-type": "application/json",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "same-origin",
            "x-requested-with": "XMLHttpRequest"
        },
        "referrerPolicy": "no-referrer",
        "body": JSON.stringify(bodyData),
        "method": "POST",
        "mode": "cors",
        "credentials": "include"
    })
    .then(response => response.json())
    .then(data => {
        transfertoTSM(data.id);
    })
    .catch(error => {
        console.error("–û—à–∏–±–∫–∞:", error);
    });
}


function transfertoTSM(Chatid) {
	if (Chatid === lastChatId) { // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π chatid —Ç–∞–∫–æ–π –∂–µ, –∫–∞–∫ –∏ –ø–µ—Ä–µ–¥—ã–¥—É—â–∏–π
        sendMattermostMessage(lastMessage); // –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ
        return; // –ü—Ä–µ–∫—Ä–∞—â–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ content.js
    }

    lastChatId = Chatid; // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π chatid

	chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
	  const activeTab = tabs[0];
	  if (activeTab) {
		chrome.tabs.sendMessage(activeTab.id, { action: "CallMMComment", Chatid: Chatid });
	  }
	});
}

